---
title: ""
format:
  pdf:
    listings: false
    documentclass: standalone
    classoption: ["border=0pt"]
    keep-tex: true
execute:
  echo: false
  warning: false
  message: false
header-includes:
  - \usepackage{graphicx}
  - \usepackage{tabularx}
  - \usepackage{array}
  - \usepackage{makecell}
  - \usepackage{multirow}
  - \usepackage{caption}
---


```{python}
#| include: false
#| echo: false
#| warning: false
#| message: false
#| error: false

from __future__ import annotations

import sys
import os
from pathlib import Path
from typing import Tuple

from svgutils.transform import fromfile, SVGFigure
import cairosvg
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.ticker as mticker

def _to_px(value: str | None) -> float:
    """
    Convertit une longueur SVG (px, mm, cm, pt, in) en pixels (float).

    Si `value` est None ou vide, retourne 0.
    """
    if not value:
        return 0.0
    value = value.strip()
    num = ''
    unit = ''
    for ch in value:
        if ch.isdigit() or ch in '.-':
            num += ch
        else:
            unit += ch
    if not num:
        return 0.0
    numf = float(num)
    unit = unit.strip().lower()
    if unit in ('', 'px'):
        return numf
    if unit == 'mm':
        return numf * 3.779527559055  # 96 dpi
    if unit == 'cm':
        return numf * 37.79527559055
    if unit == 'in':
        return numf * 96
    if unit == 'pt':
        return numf * 1.3333333333333  # 1 pt = 1/72 in
    # Fallback: assume pixels
    return numf


def _dims(fig) -> Tuple[float, float]:
    """
    Renvoie (width, height) de `fig` en pixels.

    1) viewBox (les 2 derniers termes)
    2) attributs width/height de la racine
    3) fig.get_size()
    """
    root = fig.root  # Correction ici : on accède à la balise <svg>
    viewbox = root.get('viewBox')
    if viewbox:
        parts = [p for p in viewbox.replace(',', ' ').split() if p]
        if len(parts) == 4:
            return float(parts[2]), float(parts[3])

    # attributs width/height sur la balise <svg>
    w_attr = root.get('width')
    h_attr = root.get('height')
    if w_attr and h_attr:
        return _to_px(w_attr), _to_px(h_attr)

    # fallback
    w, h = fig.get_size()
    return _to_px(w), _to_px(h)


def assemble(arome: Path, output: Path) -> str:
    """
    Assemble un PDF ne contenant que la carte AROME.
    """

    # Charger la carte AROME
    fig_arome = fromfile(str(arome))
    root_a = fig_arome.getroot()

    # Récupérer les dimensions de la figure AROME
    w_a, h_a = _dims(fig_arome)

    # Canvas de la taille d'AROME uniquement
    canvas = SVGFigure(f"{w_a}px", f"{h_a}px")
    canvas.root.set("viewBox", f"0 0 {w_a} {h_a}")

    # Positionner AROME (aucune autre carte)
    root_a.moveto(0, 0)
    canvas.append([root_a])

    # Sauvegarde SVG puis conversion en PDF
    os.makedirs(os.path.dirname(str(output)), exist_ok=True)
    canvas.save(str(output))
    cairosvg.svg2pdf(url=str(output), write_to=str(output)[:-4] + ".pdf")

    return str(output)

trend_horaire_reduce_pluie_hydro = assemble(
  "../outputs/maps/gev_z_T_p/horaire_reduce/compare_5/sat_90.0/hydro/mod_signif_norast.svg",
  "figures/trend_horaire_reduce_pluie_hydro.svg"
)
trend_horaire_reduce_pluie_ond = assemble(
  "../outputs/maps/gev_z_T_p/horaire_reduce/compare_5/sat_90.0/ond/mod_signif_norast.svg",
  "figures/trend_horaire_reduce_pluie_ond.svg"
)
trend_horaire_reduce_pluie_jfm = assemble(
  "../outputs/maps/gev_z_T_p/horaire_reduce/compare_5/sat_90.0/jfm/mod_signif_norast.svg",
  "figures/trend_horaire_reduce_pluie_jfm.svg"
)
trend_horaire_reduce_pluie_amj = assemble(
  "../outputs/maps/gev_z_T_p/horaire_reduce/compare_5/sat_90.0/amj/mod_signif_norast.svg",
  "figures/trend_horaire_reduce_pluie_amj.svg"
)
trend_horaire_reduce_pluie_jas = assemble(
  "../outputs/maps/gev_z_T_p/horaire_reduce/compare_5/sat_90.0/jas/mod_signif_norast.svg",
  "figures/trend_horaire_reduce_pluie_jas.svg"
)
```

```{=latex}
\begingroup
\noindent
\begin{minipage}[t]{\paperwidth}
  \centering
  \setlength{\tabcolsep}{0pt}
  \renewcommand{\arraystretch}{1}

  \begin{tabularx}{\paperwidth}{
    >{\centering\arraybackslash}m{0.33\paperwidth}
    >{\centering\arraybackslash}m{0.33\paperwidth}
    >{\centering\arraybackslash}m{0.33\paperwidth}
  }

  % ===== Ligne 1 =====
  \textbf{\small OND} & \textbf{\small JFM} & \textbf{\small AMJ} \\[-0.5mm]
  \includegraphics[width=\linewidth]{figures/trend_horaire_reduce_pluie_ond.pdf} &
  \includegraphics[width=\linewidth]{figures/trend_horaire_reduce_pluie_jfm.pdf} &
  \includegraphics[width=\linewidth]{figures/trend_horaire_reduce_pluie_amj.pdf} \\

  % ===== Ligne 2 =====
  \textbf{\small JAS} & \textbf{\small YEAR} &  \\[-0.5mm]
  \includegraphics[width=\linewidth]{figures/trend_horaire_reduce_pluie_jas.pdf} &
  \includegraphics[width=\linewidth]{figures/trend_horaire_reduce_pluie_hydro.pdf} &
  \begin{minipage}[c]{\linewidth}
    \centering
    \includegraphics[width=0.9\linewidth]{../outputs/maps/gev_z_T_p/horaire_reduce/compare_5/sat_90.0/legend_horiz_signif.pdf}\\
    \small \%
  \end{minipage} \\

  \end{tabularx}
\end{minipage}
\endgroup
```