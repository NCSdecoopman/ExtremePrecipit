name: Déployer une application Dockerisée sur Hugging Face Spaces

on:
  push:
    branches:
      - app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Installer Git LFS (pour gérer les gros fichiers)
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install

      - name: Préparer et pousser l'application Dockerisée
        env:
          HF_TOKEN: ${{ secrets.HF_VIZ_APP }}      # Votre token Hugging Face
          HF_USER: "ncsdecoopman"                  # Nom d'utilisateur HF
          HF_SPACE: "ExtremePrecipit"              # Nom du Space, ex. "ExtremePrecipit"
        run: |
          # ---------------------------------------------------------------------- #
          # 1. Créer un dossier "deploy" et y copier les fichiers nécessaires
          # ---------------------------------------------------------------------- #
          mkdir deploy
          rsync -av --exclude=deploy --exclude=.git --exclude=.github . deploy/

          # ---------------------------------------------------------------------- #
          # 2. Compresser TOUT le contenu de "data/" dans une archive .tar.gz
          # ---------------------------------------------------------------------- #
          if [ -d data ]; then
            cd data
            # On archive tout (fichiers + sous-dossiers)
            tar -czvf ../deploy/data_parquets.tar.gz .
            cd ..
          fi

          # ---------------------------------------------------------------------- #
          # 3. Créer un Dockerfile
          # ---------------------------------------------------------------------- #
          cat <<EOF > deploy/Dockerfile
          FROM python:3.11-slim

          RUN apt-get update && apt-get install -y \\
              build-essential \\
              git \\
              tar \\
              && rm -rf /var/lib/apt/lists/*

          WORKDIR /app

          COPY . .

          RUN mkdir -p data
          RUN tar -xzf data_parquets.tar.gz -C data/
          RUN rm data_parquets.tar.gz

          RUN pip install --no-cache-dir -r requirements.txt

          EXPOSE 7860
          ENV MPLCONFIGDIR=/tmp/matplotlib

          CMD ["streamlit", "run", "app.py", "--server.port=7860", "--server.address=0.0.0.0"]
          EOF

          # ---------------------------------------------------------------------- #
          # 4. Fichier config Hugging Face + README basique
          # ---------------------------------------------------------------------- #
          echo "sdk: docker" > deploy/.huggingface.yaml

          cat <<EOF > deploy/README.md
          # Application Streamlit - Précipitations extrêmes

          Cette application est déployée automatiquement depuis un dépôt GitHub.
          Les fichiers .parquet (et tout le dossier "data/") sont inclus dans l'image Docker
          sous forme d'archive .tar.gz, puis extraits au build.
          EOF

          if [ -d .streamlit ]; then
            cp -r .streamlit deploy/
          fi

          # ---------------------------------------------------------------------- #
          # 5. Initialiser un dépôt Git local dans "deploy" + configurer Git LFS
          # ---------------------------------------------------------------------- #
          cd deploy
          git init
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git lfs install

          # -- IMPORTANT : Dire à Git LFS de suivre l'archive data_parquets.tar.gz
          git lfs track "data_parquets.tar.gz"
          # On ajoute le fichier .gitattributes généré par git lfs track
          git add .gitattributes

          # ---------------------------------------------------------------------- #
          # 6. Pousser le code sur la Space
          # ---------------------------------------------------------------------- #
          git branch -M main
          HF_REMOTE="https://${HF_USER}:${HF_TOKEN}@huggingface.co/spaces/${HF_USER}/${HF_SPACE}"
          git remote add hf "$HF_REMOTE"

          # Ajouter tous les fichiers, y compris l'archive gérée par LFS
          git add .
          git commit -m "Déploiement Docker (avec archive .tar.gz suivie par Git LFS)"
          git push hf main --force
